2,3 계층에서는 정확한 목적지에 정보를 전송하기 위해 구성 된 계층이지만,
4계층의 프로토콜들은 [[포트]]글과  이 사진을 참고 하면 알 수 있겠지만, 운영체제 단에서 어떻게 하면 적합한 프로세스와 (포트번호로 프로세스와의 통신을 합니다) 연결할 지, 어떻게 데이터를 쪼개고 보내야, 쪼개진 데이터가 목적지에 도착해서 잘 조합될 지에 초점이 맞춰있습니다.

![[Pasted image 20231004000014.png]]

[[인캡슐레이션, 디캡슐레이션]]과정에서 데이터는 계층을 내려가고 올라가며 패킷에 추가적인 데이터를 삽입함.
이는 
- 각 계층에서 정의하는 정보
- 상위 프로토콜 지시자 정보 
입니다.

![[Pasted image 20231005150224.png]]
여기서 **각 계층에서 정의하는 정보**는 수신측의 "동일"계층에서 사용할 수 있는 데이터를 삽입하는것을 의미합니다.
예를 들어서 패킷의 2계층에서 목적지 mac 과 출발지 mac주소를 삽입하는것은 목적지의 상대의 2계층에서 mac주소를 열어서 데이터를 확인해보기를 바라고, 결국 알맞은 곳으로 데이터가 도착하기 바라기 때문입니다.
예시로는 2계층에서의 MAC주소 3계층에서의 ip 주소, 4계층에서의 ack,seq넘버등이 있겠습니다.

이에 반해, 상위 프로토콜 지시자 정보에는 상대의 아래계층에서 윗 계층으로 데이터가 올라갈때 정확한 프로토콜이나, 프로세스를 찾아 디캡슐레이션이 되기 위한 주소로 생각할 수 있습니다.

![[Pasted image 20231005150705.png]]
위의 그림과 같이 한번의 디캡슐레이션에서도 수많은 프로토콜과 프로세스가 있습니다. 
동일계층에서의 식별도 중요하지만 한단계위의 어떤 프로토콜과 연결 되는지도 안전하게 패킷이 도착하는데에는 굉장히 중요한 요소입니다.
예를들어 2계층에서는 이더타입, 3계층에서는 프로토콜 번호, 4계층은 포트 번호를 상위 프로토콜 지시자로 가집니다.

TCP/ip프로토콜에서 4계층의 상위 프로토콜 지시자는 포트번호 입니다. 
제일 위의 그림에서 볼 수 있듯이 Tcp는 소켓으로 유저 어플리케이션과 연결되어 있으며 이를 포트라 일컫습니다.
그중에서도 우리가 잘 아는 포트번호는 http tcp 80, https tcp 443, smtp tcp 25 등등이 있습니다.
![[Pasted image 20231005151725.png]]


# TCP

tcp의 역할은 간단하게 설명하자면 신뢰할 수 없는 공용망에서도 정보유실 없는 통신을 보장하기 위해 세션을 안전하게 연결하고 데이터를 분할하고 분할 된 패킷이 잘 전송되었는지 확인하는 기능이 있다.

이는 seq라고 일컫는 sequence number를 패킷에 부여하고, 잘 전송되었는지에 대해 
ack(acknowlege number)로 응답하기 때문입니다.
추가로 한꺼번에 얼마나 보내야 수신자가 잘 받아 처리할 수 있는지 전송크기(window size)까지 고려해서 통신합니다.
![[Pasted image 20231005152745.png]]
tcp에서는 안전한 송,수신을 위해서 연결전 서로 임시의 패킷을 보내는 과정을 통해서 상대방이 현재 바쁜지, 잘 작동중인지 를 확인하는 과정을 거칩니다.

이를 3방향 핸드쉐이크(three way handshake)라고 하는데, 
맨처음, 데이터를 필요로하는 컴퓨터에서 sync패킷을 지정 된 컴퓨터에 보냅니다.
예를 들어, seq번호는 300이라고 생각을 해볼 수 있습니다.

이에 수신자 컴퓨터에서는 패킷을 잘 받았다는 것을 표시하기 위해 ack는 seq에 1을 더한  301로, 수신자 컴퓨터에는 처음 패킷을 보내는 것이기 때문에, 임의의 예시 seq=40으로 표시하여 보냅니다.

다시 수신자에서 패킷을 성공적으로 받았을 경우, seq는 이전에 보냈는 seq에 1을 더해서 seq=301, ack에는 서버에서 보낸 숫자에 1을더해 41을 전송합니다.

# UDP

TCP에서는 전송을 안전하고 정확하게 처리하기 위해서 복잡한 과정과 많은 데이터가 추가가 되었습니다.
ack,res등이 추가가 되어서 정보가 쬐금 느리거나 버퍼링이 걸려도 정확한 데이터를 전송하는데에 목적이 있었는데, udp와 같은경우에는 정확한 데이터의 전송보다는 끊김없는 데이터의 전송을 목표로 합니다.

그렇기 때문에 사용처는, 적당량의 데이터 손실에는 큰 영향이없고, 데이터가 끊기는것이 예민한 서비스에서 사용합니다.
이는 실시간 화성회의 솔루션이나 실시간 스트리밍 서비스 등을 생각해 볼 수 있습니다.
