네트워크 중간에 위치해 해당 장비를 통화하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단 하는 장비를 방화벽이라고 부름

방화벽은 (NAT)동작 방식과 유사하게 세션 정보를 장비 내부에 저장 함.
처음 패킷이 나갈 때, 세션 정보를 저장하고, 패킷이 들어오거나 나갈 때 저장했던 세션 정보를 참고해 들어오는 세션이 외부에서 처음 시작 된 것인지, 사용자가 연결 한 것인지 가려냄.

이 덕분에 세션의 방향성을 쉽게 파악할 수 있다는 장점을 지닙니다. 상태정보가 없다면 방화벽에서 하나의 정책을 설정하기 위해 최소한 두개의 양방향 정책이 설정 되어야 하고, 이는 인터넷과 같은 불특정 다수와 연결 된 상황에서는 더욱 그렇습니다.

방화벽은 메모리에 남는 이런 상태와 세션 정보를 이용해 패킷을 상세히 로깅하고 관찰 할 수 있습니다.


# 세션관리

세션장비는 앞서 보았던 2,3계층의 네트워크 장비와 달리 세션 정보를 이해하고 세션 테이블을 유지합니다.
세션 테이블 정보를 이용해 패킷을 변경하거나 성능늘 최적화 하고, 보안을 강화하기 위해 패킷을 포워드 하거나 드롭할 수 있습니다.
이를 충분히 활용하기 위해선 어플리케이션과 네트워크 사이의 세션 장비를 고려해 여러가지 기능을 추가해주어야 합니다. 
특히 *비대칭 경로* 를 피하는 것이 핵심적입니다.

## 세션 테이블 유지, 정보 동기화

종단 장비에서 통신을 시작하면 중간에 있는 장비는 해당 세션 상태를 테이블에 기록합니다.
통신이 없더라도, 세션이 정상적으로 종료 된 것이 아니라면, 일정 시간 동안 세션 테이블을 유지합니다.
하지만 이런 세션 테이블도 메모리에 저장 되기 때문에 효율성의 문제로 무기한 저장 할 수도 없는 노릇이며, 세션 정보 테이블을 망가트리기 위한 공격의 루트로 사용 될 수도 있기 때문에, 타임아웃을 걸어 일정시간 이후엔 세션 정보를 삭제합니다 .

일부 애플리케이션은 다음 통신이 올때까지 연결이 끊기지 않게 타임아웃값을 길게 설정하기도 하는데, 이런경우 장비의 타임아웃값이 애플리케이션의 그것 보다 짧은경우 문제가 생길수 있습니다.

통신이 끊겼는데 syn가 아닌 ack의 패킷이 들어오면 방화벽에서는 비정상 통신으로 판단해 패킷을 차단할 가능성이 높아집니다.

## 해결방법 
### 세션 장비 운영자
- 세션 만료시간증가
  애플리케이션의 만료시간보다 방화벽 만료시간을 늘리는 방법입니다.
  정확한 정보를 알고 있어야 메모리 고갈의 문제없이 할당할 수 있기 때문에 어플 개발자가 어플 고유 세션 유지시간을 알려줘야 합니다.
  
- 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정 
  세션 정보가 없는 ack패킷이 들어오더라도 받아드리도록 설정.
  보안에 취약해짐. 비추천

- 세션 장비 타임아웃시 양 단말에 세션 종료 통보
  양 종단에 정보를 전달함.
  덕분에 양 어플리케이션 사이의 정보의 불일치에서 오는 오류를 해결 할 수 있음.
  TCP의 RST플래그를 1로 설정해서 전송하면 어플리케이션에서 비정상적으로 종료된 세션이다 판단해 연결을 끊음.

### 개발자 입장
- 애플리캐이션에서 주기적인 패킷 발생 기능 추가
  저자는 가장 좋은 타임아웃 일치 방법이라고 소개
  중간에 통신이 없더라도 더미 패킷을 주기적으로 발생, 타임 아웃이 발생하기 전에 세션을 유지함.
  
  - 비대칭 경로 문제
    네트워크의 안정성을 높이기 위해 네트워크 회선과 장비를 이중화 함.
    덕분에 나가는 패킷의 경로와 들어오는 패킷의 경로가 다를 경우가 발생할 수 있음.
    같을경우(대칭 경로), 다를 경우 (비대칭 경로) 라고 칭함.
    
    이때 경로가 다르다면 패킷이 정상적으로 전달 되지 않음. 가능하더라도 추가적인 노력이 필요하며, 보안을 취약하게 만들 수 있음.
     1. 세션 테이블 동기화
        테이블을 세션장비들 끼리 공유하도록 설정하는 것. 
        만약 공유하는 시간보다 패킷의 속도가 빠르다면, 여전히 패킷 손실의 문제 발생 할 수 있음
     2. 경로 보정
        ack패킷이 먼저 들어온다면, 다른 패킷으로 보내는 방법









